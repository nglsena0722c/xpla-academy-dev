---
sidebar_position: 4
---

# Convert 기능 적용하기

유저는 게임 보상으로 게임에서 사용하는 재화를 받습니다. 그런데 게임 재화를 받을 때마다 트랜잭션을 발생시킨다면 어떻게 될까요? 트랜잭션을 생성할 때마다 수수료가 발생하여 유저에게 부담이 될 수 있습니다.

따라서 **유저가 원할 때만 게임 재화를 블록체인 토큰으로 바꿀 수 있도록 도와주는 것**이 P2E 게임 운영 방식 중 하나입니다. 우리는 이러한 방식을 **Convert**라고 부릅니다. 이번 단계에서는 **Convert** 기능을 구현하는 방식에 대해 살펴보겠습니다.

:::danger

예제는 단순히 Web3 구현 방법 중 한 가지일 뿐이며, 하나의 정형화된 방법이 아닙니다. 예제 코드와 api, 데이터베이스 설계 등은 제작하는 사람에 따라, 혹은 게임 종류에 따라 달라질 수 있습니다. 따라서 예제 코드를 참고하여, 여러분의 기호대로 수정하시기 바랍니다.

:::

```mermaid
sequenceDiagram
    actor U as User;
    participant C as Convert server;
    participant W as XPLA_Wallet server;
    participant G as XPLA_GAME server;

    U->>C: 1. 게임 재화를 토큰으로<br/> 바꾸는 Convert 요청 
    C->>W: 2. 유저 지갑 정보, 바꾸려는<br/> 재화와 토큰 수량을 전달
    Note over W: 3. 전달 받은 내용을<br/> XPLA_Wallet DB에 기록
    W->>C: 4. ServerWallet이 유저에게 토큰을 보내고,<br/> 유저가 수수료를 내는 트랜잭션을<br/> 만들어 Convert Server에 전달
    Note over C: 5. 전달 받은 트랜잭션에<br/> 유저 지갑으로 서명 진행
    C->>W: 6. 유저 서명이 추가된<br/> 트랜잭션을 전달
    Note over W: 7. XPLA_Wallet DB에 트랜잭션 내용이<br/> 잘 있는지 한 번 더 확인
    W->>G: 8. 유저 지갑 정보,<br/> 트랜잭션 내용을 전달
    Note over G: 9. 유저가 적절한 수량만큼<br/> 게임 재화를 보유하고 있는지 확인하고,<br/> DB 내 유저 재화를 요청한 만큼 감소시킴
    Note over G: 10. 트랜잭션 내용을 DB에 기록
    G->>W: 11. DB 기록이 끝나면 <br/>XPLA_Wallet Server에 알림
    critical Sequence Mismatch 방지
        Note over W: 12. DB에서 ServerWallet의<br/> sequence 값에 Lock을 걸어주고, <br/>해당 값을 가져와 기존에 만들었던<br/> 트랜잭션에 ServerWallet으로 서명 진행
    end
    Note over W: 13. 유저 서명과 ServerWallet 서명이<br/> 모두 포함된 트랜잭션을 네트워크에 전파
    Note over W: 14. ServerWallet의 sequence 값을<br/> 1만큼 증가시키고 Lock을 해제함
    
    
```